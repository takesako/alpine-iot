# Contributor: Yoshinori Takesako <takesako@namazu.org>
# Maintainer: Yoshinori Takesako <takesako@namazu.org>
pkgname=digistump
pkgver=1.6.7
pkgrel=0
pkgdesc="Digistump support (Digispark) to avr-gcc"
url="http://digistump.com/wiki/digispark"
arch="all"
license="GPL3+"
depends=""
makedepends="binutils-avr gcc-avr gcc-avr-dev avr-libc"
install=""
subpackages=""
source="DigistumpArduino-$pkgver.tar.gz::https://github.com/digistump/DigistumpArduino/archive/$pkgver.tar.gz
	Makefile-tiny
	Makefile-DigisparkKeyboard
	"

builddir="$srcdir/DigistumpArduino-$pkgver/digistump-avr"

build() {
	cd "$builddir"
	CC="avr-gcc"
	CXX="avr-g++"
	CFLAGS="-g -Os -w -fno-exceptions -ffunction-sections -fdata-sections -MMD -mmcu=attiny85 -DF_CPU=16500000L -DARDUINO=10805 -DARDUINO_AVR_DIGISPARK -DARDUINO_ARCH_AVR -I../../cores/tiny"

	cd variants/digispark
	$CC $CFLAGS -c pins_arduino.c -o pins_arduino.o	
	cd ../..

	cd cores/tiny
	make -f ../../../../Makefile-tiny CFLAGS="$CFLAGS -I."
	cd ../..

	cd libraries/DigisparkKeyboard
	make -f ../../../../Makefile-DigisparkKeyboard CFLAGS="$CFLAGS"
	cd ../../
}

package() {
	cd "$builddir"
	mkdir -p "$pkgdir"/usr/include/$pkgname/
	mkdir -p "$pkgdir"/usr/lib/$pkgname/

	cd variants/digispark
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/ pins_arduino.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname/ pins_arduino.o
	cd ../..

	cd cores/tiny
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/ *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname/ libtiny.a
	cd ../..

	cd libraries/DigisparkKeyboard
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/ DigiKeyboard.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname/ libDigisparkKeyboard.a
	cd ../..

	# return 1
}

sha512sums="d1ac8dd5c8ee39fda2250e41a27ef2a3f184ea6f3a3de09e39d31f7f65dffc2ae95f58f048085fc57147a72e8289e86dc4948ae0145afc9307f8d43373de3d21  DigistumpArduino-1.6.7.tar.gz
2aa9521dccd0ad70912304f56624941053d4f05e75993496bc13503d9247fc2691552e605093e2e3819f6d3ebd0aa7fea408a0eeeb0d75a7a9064b6be33d4032  Makefile-tiny
41063dfdca2af97bd0a7362a428b66861faf34efc5ce1f1f65aab089b04e93bf52bdf918cc023d06470b9d84dc23db6f1f8c2e0eb603c053d0796bd30b406fbb  Makefile-DigisparkKeyboard"
