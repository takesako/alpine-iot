# Contributor: Yoshinori Takesako <takesako@namazu.org>
# Maintainer: Yoshinori Takesako <takesako@namazu.org>
pkgname=digispark
pkgver=1.6.7
pkgrel=0
pkgdesc="Digispark libraries for Digistump Arduino tiny"
url="http://digistump.com/wiki/digispark"
arch="all"
license="LGPL2.1"
depends=""
makedepends="binutils-avr gcc-avr avr-libc"
install=""
subpackages=""
source="https://github.com/digistump/DigistumpArduino/releases/download/$pkgver/digistump-avr-$pkgver.zip
	Makefile
	"

builddir="$srcdir/$pkgver"

build() {
	cd "$builddir"

	CFLAGS_OPT="-g -Os -w -fno-exceptions -ffunction-sections -fdata-sections"
	CFLAGS_TINY="-mmcu=attiny85 -DF_CPU=16500000L -DARDUINO=10805 -DARDUINO_AVR_DIGISPARK -DARDUINO_ARCH_AVR"
	CFLAGS_PRO="-mmcu=attiny167 -DF_CPU=16000000L -DARDUINO=10805 -DARDUINO_AVR_DIGISPARKPRO -DARDUINO_ARCH_AVR"

	cd cores/tiny
	sed -i -e "s/>/>\nextern \"C\" { void setup(); void loop(); int main(); }/" main.cpp
	cp -f ../../variants/digispark/pins_arduino.h .
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_TINY" \
		INCLUDES="-I." \
		SRCS="`echo *.cpp *.c`" \
		TARGET="libtiny.a"
	cd ../..

	cd cores/pro
	cp -f ../../variants/pro/pins_arduino.h .
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_PRO" \
		INCLUDES="-I." \
		SRCS="`echo *.cpp *.c`" \
		TARGET="libpro.a"
	cd ../..

	cd libraries/DigisparkKeyboard
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_TINY" \
		INCLUDES="-I../../cores/tiny" \
		SRCS="usbdrvasm.S osccal.c usbdrv.c" \
		TARGET="libDigiKeyboard.a"
	cd ../..

	cd libraries/DigisparkMouse
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_TINY" \
		INCLUDES="-I../../cores/tiny" \
		SRCS="usbdrvasm.S osccal.c usbdrv.c" \
		TARGET="libDigiMouse.a"
	cd ../..

	cd libraries/DigisparkUSB
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_TINY" \
		INCLUDES="-I../../cores/tiny" \
		SRCS="DigiUSB.cpp usbdrvasm.S osccal.c usbdrv.c" \
		TARGET="libDigiUSB.a"
	cd ../..
}

package() {
	cd "$builddir"
	mkdir -p "$pkgdir"/usr/lib/$pkgname/
	mkdir -p "$pkgdir"/usr/lib/$pkgname/pro

	examples="$pkgdir"/usr/share/$pkgname/examples
	install -D -m 644 ../../Makefile $examples/Makefile
	install -D -m 644 libraries/DigisparkKeyboard/examples/Keyboard/Keyboard.ino $examples/DigisparkKeyboard.cpp
	install -D -m 644 libraries/DigisparkMouse/examples/Mouse/Mouse.ino $examples/DigisparkMouse.cpp
	install -D -m 644 libraries/DigisparkUSB/examples/Echo/Echo.ino $examples/DigiUSB.cpp
	sed -i -e "s/>/>\nextern \"C\" { void setup(); void loop(); }/" $examples/DigiUSB.cpp

	cd cores/tiny
	mkdir -p "$pkgdir"/usr/include/$pkgname
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname libtiny.a
	cd ../..

	cd cores/pro
	mkdir -p "$pkgdir"/usr/include/$pkgname/pro
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/pro *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname/pro libpro.a
	cd ../..

	cd libraries/DigisparkKeyboard
	mkdir -p "$pkgdir"/usr/include/$pkgname/DigiKeyboard
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/DigiKeyboard *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname libDigiKeyboard.a
	cd ../..

	cd libraries/DigisparkMouse
	mkdir -p "$pkgdir"/usr/include/$pkgname/DigiMouse
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/DigiMouse *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname libDigiMouse.a
	cd ../..

	cd libraries/DigisparkUSB
	mkdir -p "$pkgdir"/usr/include/$pkgname/DigiUSB
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/DigiUSB *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname libDigiUSB.a
	cd ../..

	# return 1
}

sha512sums="95b3780a155c8e9272313b59b629c43ca80131e7cd2d6d3b2fd8ec03cfb45d1ca11ea9332c05c568cc46244e1d0fa524b388272baf4f0cd839aa4fe362321e5d  digistump-avr-1.6.7.zip
2075d68bbefdae48ea9294bdf7230b3ab7e8936b655059011c59cb5601ed74575f1f51c577fb82c6911435b43417b1a6c26914dfbd3c8bfdffc53dc61af7e7f3  Makefile"
