# Contributor: Yoshinori Takesako <takesako@namazu.org>
# Maintainer: Yoshinori Takesako <takesako@namazu.org>
pkgname=digispark
pkgver=1.6.7
pkgrel=0
pkgdesc="Digispark libraries for Digistump Arduino tiny"
url="http://digistump.com/wiki/digispark"
arch="all"
license="LGPL2.1"
depends=""
makedepends="binutils-avr gcc-avr avr-libc"
install=""
subpackages=""
source="https://github.com/digistump/DigistumpArduino/releases/download/$pkgver/digistump-avr-$pkgver.zip
	Makefile
	"

builddir="$srcdir/$pkgver"

build() {
	cd "$builddir"

	CFLAGS_OPT="-g -Os -w -fno-exceptions -ffunction-sections -fdata-sections"
	CFLAGS_TINY="-mmcu=attiny85 -DF_CPU=16500000L -DARDUINO=10805 -DARDUINO_AVR_DIGISPARK -DARDUINO_ARCH_AVR"
	CFLAGS_PRO="-mmcu=attiny167 -DF_CPU=16000000L -DARDUINO=10805 -DARDUINO_AVR_DIGISPARKPRO -DARDUINO_ARCH_AVR"

	cd cores/tiny
	cp -f ../../variants/digispark/pins_arduino.h .
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_TINY" \
		INCLUDES="-I." \
		SRCS="`echo *.cpp *.c`" \
		TARGET="libtiny.a"
	cd ../..

	cd cores/pro
	cp -f ../../variants/pro/pins_arduino.h .
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_PRO" \
		INCLUDES="-I." \
		SRCS="`echo *.cpp *.c`" \
		TARGET="libpro.a"
	cd ../..

	cd libraries/DigisparkKeyboard
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_TINY" \
		INCLUDES="-I../../cores/tiny" \
		SRCS="usbdrvasm.S osccal.c usbdrv.c" \
		TARGET="libDigisparkKeyboard.a"
	cd ../..

	cd libraries/DigisparkMouse
	make -f ../../../../Makefile \
		CFLAGS="$CFLAGS_OPT $CFLAGS_TINY" \
		INCLUDES="-I../../cores/tiny" \
		SRCS="usbdrvasm.S osccal.c usbdrv.c" \
		TARGET="libDigisparkMouse.a"
	cd ../..
}

package() {
	cd "$builddir"
	mkdir -p "$pkgdir"/usr/lib/$pkgname/
	mkdir -p "$pkgdir"/usr/lib/$pkgname/pro

	examples="$pkgdir"/usr/share/$pkgname/examples
	install -D -m 644 ../../Makefile $examples/Makefile
	install -D -m 644 libraries/DigisparkKeyboard/examples/Keyboard/Keyboard.ino $examples/DigisparkKeyboard.cpp
	install -D -m 644 libraries/DigisparkMouse/examples/Mouse/Mouse.ino $examples/DigisparkMouse.cpp

	cd cores/tiny
	mkdir -p "$pkgdir"/usr/include/$pkgname
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname libtiny.a
	cd ../..

	cd cores/pro
	mkdir -p "$pkgdir"/usr/include/$pkgname/pro
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/pro *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname/pro libpro.a
	cd ../..

	cd libraries/DigisparkKeyboard
	mkdir -p "$pkgdir"/usr/include/$pkgname/DigisparkKeyboard
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/DigisparkKeyboard *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname libDigisparkKeyboard.a
	cd ../..

	cd libraries/DigisparkMouse
	mkdir -p "$pkgdir"/usr/include/$pkgname/DigisparkMouse
	install -D -m 644 -t "$pkgdir"/usr/include/$pkgname/DigisparkMouse *.h
	install -D -m 644 -t "$pkgdir"/usr/lib/$pkgname libDigisparkMouse.a
	cd ../..

	# return 1
}

sha512sums="95b3780a155c8e9272313b59b629c43ca80131e7cd2d6d3b2fd8ec03cfb45d1ca11ea9332c05c568cc46244e1d0fa524b388272baf4f0cd839aa4fe362321e5d  digistump-avr-1.6.7.zip
463a7dcf93de8586564928fb1ea9999e741570f250c6f087237be7c82a448d9d8316e6c052cef00ec0650691f376cefab9de0cd76f528aba38066dc0e72b8ca7  Makefile"
